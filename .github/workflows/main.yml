name: Deploy to Azure VM (Docker)

on:
  push:
    branches: [ "main" ]
    paths:
      - "cloud_infra/ansible/app/**"   # trigger when your app changes
      - ".github/workflows/main.yml"
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      VM_HOST: ${{ secrets.VM_HOST }}
      VM_USER: ${{ secrets.VM_USER }}
      VM_SSH_PORT: ${{ secrets.VM_SSH_PORT || '22' }}
      HOST_PORT: '80'
      CONTAINER_NAME: sampleapp
      IMAGE_TAG: cloud_infra/sampleapp:latest
      APP_DIR_REMOTE: /tmp/test # user-writable

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show workspace (debug)
        run: |
          pwd
          find . -maxdepth 4 -type f | sed -n '1,200p'

      - name: Prepare remote dir
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ env.VM_USER }}
          port: ${{ env.VM_SSH_PORT }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            mkdir -p "${{ env.APP_DIR_REMOTE }}"
            chown -R "${{ env.VM_USER }}:${{ env.VM_USER }}" "${{ env.APP_DIR_REMOTE }}"

      - name: Copy app files to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ env.VM_USER }}
          port: ${{ env.VM_SSH_PORT }}
          source: "cloud_infra/ansible/app/**"   # <-- your app path
          target: "${{ env.APP_DIR_REMOTE }}"
          overwrite: true
          strip_components: 3                    # drop cloud_infra/ansible/app
          key: ${{ secrets.VM_SSH_KEY }}

      - name: Build image & restart container on VM
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ env.VM_USER }}
          port: ${{ env.VM_SSH_PORT }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            set -e
            ls -la "${{ env.APP_DIR_REMOTE }}"
            cd "${{ env.APP_DIR_REMOTE }}"
            sudo docker build -t "${{ env.IMAGE_TAG }}" .
            if [ "$(sudo docker ps -q -f name=${{ env.CONTAINER_NAME }})" ]; then
              sudo docker stop "${{ env.CONTAINER_NAME }}" && sudo docker rm "${{ env.CONTAINER_NAME }}"
            elif [ "$(sudo docker ps -aq -f name=${{ env.CONTAINER_NAME }})" ]; then
              sudo docker rm "${{ env.CONTAINER_NAME }}"
            fi
            sudo docker run -d \
              --name "${{ env.CONTAINER_NAME }}" \
              --restart unless-stopped \
              -p "${{ env.VM_HOST }}:8080" \
              "${{ env.IMAGE_TAG }}"
            sudo docker ps --filter "name=${{ env.CONTAINER_NAME }}"
